## =============================================================================
## EDR Baseline Telemetry Rules for io_uring Evasion Experiment
## =============================================================================
## 
## Purpose: Capture syscall activity for traditional binaries to compare
##          against io_uring variants (which bypass these rules).
##
## Usage:
##   sudo auditctl -R /path/to/99-edr-baseline.rules
##   sudo auditctl -l  # verify rules loaded
##
## To remove rules:
##   sudo auditctl -D
##
## =============================================================================

## ---------------------------
## Delete any existing rules (clean slate)
## ---------------------------
-D

## ---------------------------
## Set buffer size and failure mode
## ---------------------------
-b 8192
-f 1

## ---------------------------
## Process Execution
## ---------------------------
## Captures: fork, clone, execve
## Traditional binary: exec_cmd_trad
## io_uring: N/A (execve cannot be done via io_uring)
##
-a always,exit -F arch=b64 -S execve -k exec_baseline
-a always,exit -F arch=b32 -S execve -k exec_baseline
-a always,exit -F arch=b64 -S execveat -k exec_baseline
-a always,exit -F arch=b32 -S execveat -k exec_baseline

## ---------------------------
## File Operations
## ---------------------------
## Captures: open, openat, read, write, close
## Traditional binaries: file_io_trad, read_file_trad
## io_uring variants: file_io_uring (IORING_OP_WRITE/READ), openat_uring (IORING_OP_OPENAT)
##
## Note: io_uring file operations do NOT trigger these rules - that's the point!
##
-a always,exit -F arch=b64 -S open,openat,openat2 -k file_baseline
-a always,exit -F arch=b32 -S open,openat,openat2 -k file_baseline
-a always,exit -F arch=b64 -S read,readv,pread64,preadv,preadv2 -k file_baseline
-a always,exit -F arch=b32 -S read,readv,pread64,preadv,preadv2 -k file_baseline
-a always,exit -F arch=b64 -S write,writev,pwrite64,pwritev,pwritev2 -k file_baseline
-a always,exit -F arch=b32 -S write,writev,pwrite64,pwritev,pwritev2 -k file_baseline
-a always,exit -F arch=b64 -S close -k file_baseline
-a always,exit -F arch=b32 -S close -k file_baseline

## ---------------------------
## Network Operations
## ---------------------------
## Captures: socket, connect, send, recv, etc.
## Traditional binary: net_connect_trad
## io_uring variant: net_connect_uring (IORING_OP_CONNECT/SEND/RECV)
##
## Note: io_uring network operations do NOT trigger these rules - that's the point!
##
-a always,exit -F arch=b64 -S socket -k net_baseline
-a always,exit -F arch=b32 -S socket -k net_baseline
-a always,exit -F arch=b64 -S connect -k net_baseline
-a always,exit -F arch=b32 -S connect -k net_baseline
-a always,exit -F arch=b64 -S accept,accept4 -k net_baseline
-a always,exit -F arch=b32 -S accept,accept4 -k net_baseline
-a always,exit -F arch=b64 -S sendto,sendmsg,sendmmsg -k net_baseline
-a always,exit -F arch=b32 -S sendto,sendmsg,sendmmsg -k net_baseline
-a always,exit -F arch=b64 -S recvfrom,recvmsg,recvmmsg -k net_baseline
-a always,exit -F arch=b32 -S recvfrom,recvmsg,recvmmsg -k net_baseline

## ---------------------------
## io_uring Setup (for detecting io_uring usage itself)
## ---------------------------
## This captures when io_uring is initialized - useful for behavioral detection
## Even though we can't see WHAT io_uring does, we CAN see that it was set up
##
-a always,exit -F arch=b64 -S io_uring_setup,io_uring_enter,io_uring_register -k iouring_setup
-a always,exit -F arch=b32 -S io_uring_setup,io_uring_enter,io_uring_register -k iouring_setup

## ---------------------------
## Make config immutable (optional - uncomment for production)
## ---------------------------
## Once enabled, rules cannot be changed without a reboot
## -e 2
